<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TikTok Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-2xl bg-gray-800 p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4">TikTok Downloader</h1>
    <form id="downloadForm" class="flex gap-2 mb-4">
      <input id="tiktokUrl" type="url" placeholder="Paste TikTok URL" class="flex-1 p-2 rounded bg-gray-700 text-white outline-none">
      <button class="bg-green-600 px-4 py-2 rounded">Fetch</button>
    </form>
    <div id="message" class="mb-3 text-sm"></div>
    <div id="result"></div>
  </div>

<script>
const form=document.getElementById("downloadForm");
const urlInput=document.getElementById("tiktokUrl");
const msg=document.getElementById("message");
const result=document.getElementById("result");

form.addEventListener("submit",async e=>{
  e.preventDefault();result.innerHTML="";show("Fetching...","info");
  try{
    const res=await fetch("https://www.tikwm.com/api/",{
      method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:"url="+encodeURIComponent(urlInput.value)
    });
    const {code,data,msg:err}=await res.json();
    if(code!==0||!data) throw new Error(err||"Invalid link");
    const safe=`${data.author?.nickname||"author"}_${data.title||"tiktok"}`.replace(/[^a-zA-Z0-9_]/g,"_").substring(0,50);
    data.images?.length?showPhotos(data.images,safe):showVideo(data.play,data.music,safe);
    show("Success!","success");
  }catch(err){console.error(err);show("Error: "+err.message,"error");}
});

function show(text,type){
  const colors={success:"text-green-400",error:"text-red-400",info:"text-blue-400"};
  msg.className=colors[type]||"";msg.textContent=text;
}

function showVideo(video,audio,name){
  result.innerHTML=`<div class="bg-gray-700 p-4 rounded-lg">
    <video src="${video}" controls class="w-full mb-3 rounded"></video>
    <div class="flex flex-col gap-2">
      <button onclick="forceDownload('${video}','${name}.mp4',this)" class="bg-green-600 p-2 rounded"><span>Save Video</span></button>
      <button onclick="forceDownload('${audio}','${name}.mp3',this)" class="bg-blue-600 p-2 rounded"><span>Save Audio</span></button>
    </div>
  </div>`;
}

function showPhotos(images,name){
  result.innerHTML=`<div class="bg-gray-700 p-4 rounded-lg">
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4">
      ${images.map((img,i)=>`
        <div class="relative border border-gray-600 rounded-lg overflow-hidden">
          <img src="${img}" class="w-full h-32 object-cover">
          <input type="checkbox" value="${img}" class="absolute top-2 left-2 w-5 h-5 accent-green-500">
          <button onclick="forceDownload('${img}','${name}_${i+1}.jpg',this)" 
            class="absolute bottom-2 right-2 bg-black/60 text-white px-2 py-1 rounded text-xs">
            <span>Save</span>
          </button>
        </div>`).join("")}
    </div>
    <div class="flex justify-between gap-2">
      <input type="text" id="filenameInput" value="${name}" class="flex-1 bg-gray-600 p-2 rounded text-sm outline-none">
      <button onclick="downloadSelected('${name}',this)" class="bg-purple-600 px-4 py-2 rounded text-sm"><span>Download Selected</span></button>
    </div>
  </div>`;
}

async function forceDownload(url,extOrName,btn){
  const input=document.getElementById("filenameInput");
  const name=input?input.value.trim():"download";
  const fname=extOrName.startsWith(".")?name+extOrName:extOrName;
  const span=btn.querySelector("span")||btn;
  const old=span.textContent;btn.disabled=true;span.textContent="Preparing...";
  try{const r=await fetch(url);if(!r.ok)throw new Error("Network error");
    const b=await r.blob();saveAs(b,fname);show("Download started!","success");
  }catch(e){console.error(e);show("Failed to download.","error");}
  btn.disabled=false;span.textContent=old;
}

async function downloadSelected(baseName,btn){
  const boxes=[...result.querySelectorAll("input[type=checkbox]:checked")];
  if(!boxes.length){show("No photos selected.","error");return;}
  const files=boxes.map(b=>b.value);
  const input=document.getElementById("filenameInput");
  const name=input?input.value.trim()||baseName:baseName;
  const span=btn.querySelector("span")||btn;
  const old=span.textContent;btn.disabled=true;span.textContent="Processing...";

  try{
    if(files.length===1){ // single photo → save directly
      const b=await fetch(files[0]).then(r=>r.blob());
      saveAs(b,`${name}.jpg`);
    }else{ // multiple → zip
      const zip=new JSZip();let i=1;
      for(const u of files){const b=await fetch(u).then(r=>r.blob());zip.file(`${name}_${i++}.jpg`,b);}
      const c=await zip.generateAsync({type:"blob"});saveAs(c,`${name}.zip`);
    }
    show("Download ready!","success");
  }catch(e){console.error(e);show("Download failed.","error");}
  btn.disabled=false;span.textContent=old;
}
</script>
</body>
</html>
